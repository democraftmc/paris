---
import Layout from "../layouts/Layout.astro";
---

<Layout title="DEMOCRAFT | Language Selection">
    <div class="h-screen w-screen bg-base-100 flex flex-col gap-4 items-center justify-center">
        <img class="h-32 w-32 animate-pulse" src="/logo.png" />


        <dialog id="lang_modal" class="modal">
            <div class="modal-box">
                <h3 class="text-lg text-center font-bold">Select a language</h3>
                <p>This website is avaible in multiples languages.
                    Select the language you are most xx of to get started.</p>
                <p>
                   Ce site est disponible en plusieurs langues.
                   SÃ©lÃ©ctionnez la langue qui vous est la plus familiÃ¨re pour commencer.  
                </p>
                <div class="flex justify-center w-full gap-4 pt-4">
                    <!-- replaced anchors with buttons so we can set localStorage before redirect -->
                    <button class="btn px-8 py-8 text-4xl md:text-6xl" data-lang="fr" aria-label="FranÃ§ais">ðŸ‡«ðŸ‡·</button>
                    <button class="btn px-8 py-8 text-4xl md:text-6xl" data-lang="en" aria-label="English">ðŸ‡¬ðŸ‡§</button>
                </div>
            </div>
        </dialog>

    </div>

    <script>
        const SUPPORTED_LANGS = ['fr', 'en'];

        function setLangAndRedirect(lang) {
            if (!lang) return;
            localStorage.setItem('lang', lang);
            location.replace('/' + lang);
        }

        document.addEventListener('DOMContentLoaded', () => {
            try {
                const stored = localStorage.getItem('lang');
                if (stored && SUPPORTED_LANGS.includes(stored)) {
                    location.replace('/' + stored);
                    return;
                }

                // try browser preferred language
                const navLang = (navigator.languages && navigator.languages[0]) || navigator.language || navigator.userLanguage || '';
                const short = navLang.slice(0,2).toLowerCase();
                if (short && SUPPORTED_LANGS.includes(short)) {
                    localStorage.setItem('lang', short);
                    location.replace('/' + short);
                    return;
                }
            } catch (e) {
                // localStorage may be disabled â€” fall back to showing the modal
                console.warn('lang detection error', e);
            }

            // show modal if no redirect happened
            const modal = document.getElementById('lang_modal');
            if (modal && typeof modal.showModal === 'function') {
                modal.showModal();
            } else {
                // fallback: simple alert with basic redirect choices
                const choice = (prompt('Select language: "fr" or "en"') || '').toLowerCase();
                if (SUPPORTED_LANGS.includes(choice)) {
                    setLangAndRedirect(choice);
                }
            }

            // wire buttons in modal
            document.querySelectorAll('[data-lang]').forEach(btn => {
                btn.addEventListener('click', (ev) => {
                    const lang = btn.getAttribute('data-lang');
                    setLangAndRedirect(lang);
                });
            });
        });
    </script>
</Layout>